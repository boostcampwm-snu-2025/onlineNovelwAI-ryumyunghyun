// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
// User model
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  penName       String
  profileImage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // JSON fields for complex structures
  preferences   Json     // UserPreferences
  stats         Json     // UserStats
  
  // Relations
  novels        Novel[]
  achievements  UserAchievement[]
  notifications Notification[]
  sessions      Session[]
  
  @@map("users")
}

// Novel model
model Novel {
  id          String   @id @default(uuid())
  authorId    String
  title       String
  description String
  genre       String
  coverImage  String?
  status      String   @default("draft")
  visibility  String   @default("private")
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  metadata    Json     // NovelMetadata
  
  // Relations
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  chapters    Chapter[]
  metrics     NovelMetrics[]
  contexts    AIConversationContext[]
  
  @@map("novels")
}

// Chapter model
model Chapter {
  id            String   @id @default(uuid())
  novelId       String
  chapterNumber Int
  title         String
  content       String   @db.Text
  wordCount     Int
  status        String   @default("draft")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  publishedAt   DateTime?
  notes         String?  @db.Text
  
  // Relations
  novel         Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  reviews       AIReview[]
  
  @@unique([novelId, chapterNumber])
  @@map("chapters")
}

// AI Persona model
model AIPersona {
  id           String   @id @default(uuid())
  name         String
  type         String
  description  String
  avatarImage  String
  systemPrompt String   @db.Text
  traits       Json     // PersonaTrait[]
  rating       Json     // {minScore, maxScore}
  isActive     Boolean  @default(true)
  color        String
  createdAt    DateTime @default(now())
  
  // Relations
  reviews      AIReview[]
  contexts     AIConversationContext[]
  
  @@map("ai_personas")
}

// AI Review model
model AIReview {
  id             String   @id @default(uuid())
  chapterId      String
  personaId      String
  novelId        String
  overallRating  Float
  sentiment      String
  reviewText     String   @db.Text
  strengths      String[]
  improvements   String[]
  detailedScores Json     // ReviewScores
  quotes         Json     // ReviewQuote[]
  contextAware   Boolean  @default(false)
  generatedAt    DateTime @default(now())
  aiModel        String
  tokenUsage     Int
  metadata       Json?    // ReviewMetadata
  
  // Relations
  chapter        Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  persona        AIPersona @relation(fields: [personaId], references: [id])
  
  @@map("ai_reviews")
}

// Novel Metrics model
model NovelMetrics {
  id             String   @id @default(uuid())
  novelId        String
  recordedAt     DateTime @default(now())
  snapshot       Json     // MetricsSnapshot
  personaMetrics Json     // PersonaMetric[]
  
  // Relations
  novel          Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  @@map("novel_metrics")
}

// Achievement model
model Achievement {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String
  icon        String
  category    String
  requirement Json     // AchievementRequirement
  rarity      String
  points      Int
  createdAt   DateTime @default(now())
  
  // Relations
  userAchievements UserAchievement[]
  
  @@map("achievements")
}

// User Achievement junction
model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())
  progress      Int      @default(0)
  isNotified    Boolean  @default(false)
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  
  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// AI Conversation Context
model AIConversationContext {
  id               String   @id @default(uuid())
  novelId          String
  personaId        String
  chapterHistory   Json     // ChapterContext[]
  characterMemory  Json     // CharacterMemory[]
  plotPoints       Json     // PlotPoint[]
  worldBuilding    Json     // WorldBuildingElement[]
  lastUpdated      DateTime @default(now())
  embeddingVersion String?
  
  // Relations
  novel            Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  persona          AIPersona @relation(fields: [personaId], references: [id])
  
  @@unique([novelId, personaId])
  @@map("ai_conversation_contexts")
}

// Notification model
model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  expiresAt DateTime?
  metadata  Json?
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

// Session model
model Session {
  id             String   @id @default(uuid())
  userId         String
  token          String   @unique
  ipAddress      String
  userAgent      String
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  lastActivityAt DateTime @default(now())
  isActive       Boolean  @default(true)
  
  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}
